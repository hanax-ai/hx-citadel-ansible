# HX-Citadel Ansible Status — 7 Oct 2025

## Project snapshot

- **Control node:** `hx-devops-server`
- **Repository:** [`hanax-ai/hx-citadel-ansible`](https://github.com/hanax-ai/hx-citadel-ansible)
- **Latest commit:** `feat: bootstrap ansible project structure`
- **Validation:** `ansible-playbook --syntax-check site.yml` (pass); `deploy-orchestrator-local.yml` end-to-end run on `hx-orchestrator-server` (pass)
- **HX-QWUI target:** Reimaged to `hx-qwui-server` at `192.168.10.58` (was `192.168.10.54`)

## Configuration summary

### Ansible core

- `ansible.cfg` enables inventory at `inventory/prod.ini`, role discovery via `roles/`, fact caching (`jsonfile`) and SSH pipelining for speed.
- Galaxy dependencies declared in `requirements.yml` (postgresql, redis roles + `community.docker`, `community.general`).

### Inventory & variables

- `inventory/prod.ini` tracks 15 Ubuntu 24.04 hosts grouped by responsibility (db/vector/llm/api/orchestrator/monitoring).
- `group_vars/all/main.yml` standardizes Python 3.12, app directory `/opt/hx-citadel-shield`, log directory `/var/log/hx-citadel`.
- `group_vars/db_nodes.yml` sets Postgres/Redis defaults; `group_vars/llm_nodes.yml` defines Ollama port 11434 and 4-hour sync cadence.
- Host vars pin live Ollama model manifests per node and orchestrator env wiring (`QDRANT_URL`, `LITELLM_URL`).
- `group_vars/all/vault.yml` committed as a placeholder—needs encryption before injecting secrets (`orch_secret`, database creds, API keys).
- Vault now holds `qdrant_api_key` and `qdrant_endpoint` (`https://192.168.10.9:6333/collections`) alongside Ansible and database secrets.

### Vault rotation workflow (NEW)

- Vault password now rotates automatically via the `hx-vault-rotation` scheduled job. Retrieve the current secret just-in-time before any playbook run:
   1. `op read op://Infra/HX-Citadel-Ansible/VaultPassword/password > /tmp/.vault-pass`
   2. Export or prefix the playbook invocation with `ANSIBLE_VAULT_PASSWORD_FILE=/tmp/.vault-pass`
   3. After the run, wipe the ephemeral file with `shred -u /tmp/.vault-pass`
- All operators must follow this workflow; the legacy static files (`~/.ansible/vault-pass-dev`, `~/hx-ansible/.vault_pass.txt`) are deprecated and no longer work.

### Roles & playbooks

- Eight roles (`base-setup`, `postgresql`, `redis`, `qdrant`, `ollama`, `litellm`, `prisma`, `fastapi`, `observability`) with tasks/vars/handlers/templates scaffolded for idempotent installs. Redis and Qdrant now ship native packages with handlers guarded for check mode; API plays split to avoid cross-host handlers.
- Playbooks per tier (`playbooks/deploy-*.yml`) plus `site.yml` orchestrating the full stack in dependency order. Added `deploy-orchestrator-local.yml` to seed a minimal FastAPI service (Poetry-managed, systemd unit, /healthz check) directly on `hx-orchestrator-server` with no git dependency.
- README updated with team runbook: prerequisites, dry-run, targeted deploy, health verification.

## Lessons learned

- **Host-specific model drift:** Source-of-truth needs to live in `host_vars`—confirmed by cross-checking `ollama list` outputs on hx-ollama1/2. Expect future automation to reconcile differences automatically.
- **Role modularity pays off:** Building minimal but complete task skeletons early clarified variable surfaces and highlighted where Galaxy roles can accelerate delivery (PostgreSQL, Redis). Splitting API plays eliminated handler cross-fire between Prisma and LiteLLM hosts.
- **Command idempotency matters:** Shell-based steps (e.g., Ollama install, NodeJS deb) require `creates`/`changed_when` guards; we added these where practical but should audit before first production run.
- **Local seeding beats blocked git:** With no upstream orchestrator repo, the dedicated playbook seeds a minimal FastAPI app locally; baking repeatable scaffolding saved future manual handoffs despite the time cost today.
- **Documentation cadence:** Updating README and capturing syntax-check results during bootstrap gives the junior team a reliable starting point; continue versioning operational notes in-repo.

## Blockers / risks

- **Secrets management pending:** Vault file is unencrypted; deployments cannot proceed until secrets (`HB_ANSIBLE_VAR`, `HX_ANSIBLE_SECRET`, database passwords, API keys) are vaulted and referenced in roles.
- **FastAPI role still points to non-existent git repo:** `roles/fastapi/tasks/main.yml` expects `hanax-ai/hx-orchestrator.git`; until we re-home the source or swap in the new local approach, the fastapi portion of `site.yml` will continue to fail.
- **NodeJS install approach:** Using `apt` with a direct `.deb` URL may require prior keyring setup or may fail if Nodesource revs filenames—consider switching to official setup script or Ubuntu repo if issues arise.
- **Service templates partially validated:** New local-playbook confirmed the orchestrator systemd unit and `/healthz` responder, but LiteLLM/Prisma templates remain untested on targets.
- **Observability wiring:** Prometheus scrape target currently single host (`hx-orchestrator-server:8000`); ensure exporters/endpoints exist and update targets as services expose metrics.

## Next steps

1. **Vault secrets**
   - `ansible-vault encrypt group_vars/all/vault.yml`
   - Insert `HB_ANSIBLE_VAR`, `HX_ANSIBLE_SECRET`, Postgres credentials, Qdrant API key.
   - Document secret retrieval: confirm every operator can fetch the rotating password via `op read op://Infra/HX-Citadel-Ansible/VaultPassword/password > /tmp/.vault-pass` before execution.
2. **Decide FastAPI deployment path**
   - Either publish/point to the real orchestrator repository or retire the git-driven role in favour of `deploy-orchestrator-local.yml` wired into `site.yml`/`fastapi` role.
   - Until resolved, skip `--tags fastapi` when running `site.yml` to avoid hard failures.
3. **Install Galaxy dependencies**
   - `ansible-galaxy install -r requirements.yml`
4. **Smoke test roles**
   - `ansible-playbook playbooks/deploy-llm.yml --limit hx-ollama1 --check`
   - Iterate on Ollama role until no changes in check mode, then repeat for other tiers; follow up with a full `site.yml --check --diff -b` once FastAPI path is settled.
5. **Harden install commands**
   - Replace shell-based installers with package modules or additional guards where feasible.
6. **Expand observability**
   - Add Grafana dashboards, systemd targets, and integrate HealthService into FastAPI app entrypoint.
7. **Document runbooks**
   - Capture first dry-run results, troubleshooting notes, and update README/STATUS as gaps close.

## Open questions for the team

- Preferred approach for NodeJS provisioning (Nodesource vs. distro vs. container)?
- Confirm whether an external orchestrator repo will exist, or if the local-seeded playbook should become the authoritative deployment path.
- Preferred approach for NodeJS provisioning (Nodesource vs. distro vs. container)?
- Any additional hosts or environment-specific overrides to add before first deployment window?
