-- Shield Orchestrator Database Initialization
-- Component 3: PostgreSQL Integration
-- Generated by Ansible on {{ ansible_date_time.iso8601 }}

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create orchestrator role if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'orchestrator') THEN
    CREATE ROLE orchestrator WITH LOGIN PASSWORD '{{ vault_postgres_orchestrator_password }}';
  END IF;
END
$$;

-- Set role attributes
ALTER ROLE orchestrator WITH CREATEDB NOSUPERUSER INHERIT;

-- Create database if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'shield_orchestrator') THEN
    CREATE DATABASE shield_orchestrator
      WITH OWNER = orchestrator
           ENCODING = 'UTF8'
           LC_COLLATE = 'en_US.UTF-8'
           LC_CTYPE = 'en_US.UTF-8'
           TEMPLATE = template0
           CONNECTION LIMIT = -1;
  END IF;
END
$$;

-- Grant privileges
GRANT ALL PRIVILEGES ON DATABASE shield_orchestrator TO orchestrator;
GRANT CONNECT ON DATABASE shield_orchestrator TO orchestrator;

-- Comment on database
COMMENT ON DATABASE shield_orchestrator IS 'Shield Orchestrator Intelligence Hub Database';

\echo 'Database setup complete!'
