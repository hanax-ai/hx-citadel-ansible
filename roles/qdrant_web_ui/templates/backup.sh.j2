#!/usr/bin/env bash
set -euo pipefail
BACKUP_DIR="{{ qdrant_ui_root }}/backups"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_PREFIX="qdrant-ui-backup-${TIMESTAMP}"
mkdir -p "${BACKUP_DIR}"

log() {
  echo "$(date --iso-8601=seconds): $1" >> "{{ qdrant_ui_root }}/logs/backup.log"
}

log "Starting backup ${BACKUP_PREFIX}"

tar -czf "${BACKUP_DIR}/${BACKUP_PREFIX}-config.tar.gz" /etc/nginx/sites-available/qdrant-ui {{ qdrant_ui_root }}/config

tar -czf "${BACKUP_DIR}/${BACKUP_PREFIX}-build.tar.gz" -C {{ qdrant_ui_root }}/builds/current .

tar -czf "${BACKUP_DIR}/${BACKUP_PREFIX}-logs.tar.gz" -C {{ qdrant_ui_root }}/logs .

find "${BACKUP_DIR}" -name "*.tar.gz" -mtime +{{ qdrant_ui_backup_retention_days }} -delete

log "Backup ${BACKUP_PREFIX} completed"
