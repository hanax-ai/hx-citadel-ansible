# Prometheus Scrape Configuration for Shield MCP Server
# Generated by Ansible for {{ ansible_hostname }}
#
# Add this to Prometheus configuration on hx-metrics-server.dev-test.hana-x.ai
# Location: /etc/prometheus/prometheus.yml

# FastMCP Server Health and Metrics Endpoint
- job_name: 'shield-mcp-server'
  scrape_interval: 30s
  scrape_timeout: 10s
  metrics_path: '/health'
  scheme: http
  static_configs:
    - targets: ['{{ ansible_host }}:{{ fastmcp_port }}']
      labels:
        environment: '{{ deployment_environment | default("production") }}'
        service: 'shield-mcp'
        role: 'mcp-server'
        hostname: '{{ ansible_hostname }}'
        datacenter: 'hx-citadel'

# Optional: Separate job for detailed MCP tool metrics
- job_name: 'shield-mcp-tools'
  scrape_interval: 60s
  scrape_timeout: 10s
  metrics_path: '/metrics'
  scheme: http
  static_configs:
    - targets: ['{{ ansible_host }}:{{ fastmcp_port }}']
      labels:
        environment: '{{ deployment_environment | default("production") }}'
        service: 'shield-mcp-tools'
        role: 'mcp-server'
        hostname: '{{ ansible_hostname }}'
        datacenter: 'hx-citadel'

# Alerting Rules Configuration
# Add to /etc/prometheus/rules/shield-mcp-alerts.yml

groups:
  - name: shield_mcp_alerts
    interval: 30s
    rules:
      # Service availability alert
      - alert: ShieldMCPDown
        expr: up{job="shield-mcp-server"} == 0
        for: 2m
        labels:
          severity: critical
          service: shield-mcp
        annotations:
          summary: "Shield MCP Server is down"
          description: "Shield MCP Server on {{ ansible_hostname }} ({{ ansible_host }}) has been down for more than 2 minutes."

      # Health check failure alert
      - alert: ShieldMCPUnhealthy
        expr: probe_success{job="shield-mcp-server"} == 0
        for: 5m
        labels:
          severity: warning
          service: shield-mcp
        annotations:
          summary: "Shield MCP Server health check failing"
          description: "Shield MCP Server on {{ ansible_hostname }} is reporting unhealthy status."

      # High response time alert
      - alert: ShieldMCPHighLatency
        expr: probe_duration_seconds{job="shield-mcp-server"} > 5
        for: 5m
        labels:
          severity: warning
          service: shield-mcp
        annotations:
          summary: "Shield MCP Server high latency"
          description: "Shield MCP Server on {{ ansible_hostname }} is experiencing high response times (>5s)."

      # Dependency failure alerts
      - alert: ShieldMCPQdrantDown
        expr: fastmcp_dependency_status{service="qdrant"} == 0
        for: 5m
        labels:
          severity: warning
          service: shield-mcp
          dependency: qdrant
        annotations:
          summary: "Shield MCP cannot reach Qdrant"
          description: "Shield MCP Server cannot connect to Qdrant vector database."

      - alert: ShieldMCPOllamaDown
        expr: fastmcp_dependency_status{service="ollama"} == 0
        for: 5m
        labels:
          severity: warning
          service: shield-mcp
          dependency: ollama
        annotations:
          summary: "Shield MCP cannot reach Ollama"
          description: "Shield MCP Server cannot connect to Ollama LLM service."

      # Tool execution error rate
      - alert: ShieldMCPHighErrorRate
        expr: rate(fastmcp_tool_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: shield-mcp
        annotations:
          summary: "High error rate in Shield MCP tools"
          description: "Shield MCP Server is experiencing >10% error rate in tool executions."

# Grafana Dashboard Configuration
# Import this JSON to Grafana for visualization

# Dashboard panels to create:
# 1. Service Uptime (gauge) - up{job="shield-mcp-server"}
# 2. Health Status (stat) - probe_success{job="shield-mcp-server"}
# 3. Response Time (graph) - probe_duration_seconds{job="shield-mcp-server"}
# 4. Tool Execution Count (counter) - rate(fastmcp_tool_executions_total[5m])
# 5. Tool Error Rate (graph) - rate(fastmcp_tool_errors_total[5m])
# 6. Dependency Status (stat panel) - fastmcp_dependency_status
# 7. Request Rate (graph) - rate(fastmcp_requests_total[5m])
# 8. Active Connections (gauge) - fastmcp_active_connections

# Recommended Retention Policy
# For Shield MCP metrics: 90 days
# Add to Prometheus flags: --storage.tsdb.retention.time=90d
