---
# Task: Configure sudo permissions for service management
# Purpose: Allow service user to manage systemd services without password
# Variables used:
#   - service_user: User that runs the application services (default: agent0)
#   - sudo_enabled: Enable/disable sudo configuration (default: true)
#   - app_name: Application name for sudo config (default: hx-citadel)

- name: Ensure sudo package is installed
  apt:
    name: sudo
    state: present
  become: yes
  when: sudo_enabled | default(true)
  tags:
    - sudo
    - packages

- name: Create sudoers.d configuration for service management
  template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/{{ app_name | default('hx-citadel') }}-services"
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'
  become: yes
  when: sudo_enabled | default(true)
  tags:
    - sudo
    - config

- name: Verify sudo configuration
  command: sudo -l -U {{ service_user | default('agent0') }}
  become: yes
  changed_when: false
  register: sudo_check
  when: sudo_enabled | default(true)
  tags:
    - sudo
    - validation

- name: Display sudo permissions
  debug:
    msg: "Sudo permissions configured for {{ service_user | default('agent0') }}"
  when: 
    - sudo_enabled | default(true)
    - sudo_check is defined
  tags:
    - sudo
    - validation
